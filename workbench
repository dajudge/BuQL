#! /bin/bash

set -e

DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" >/dev/null 2>&1 && pwd )"

IMG=$(docker build \
    --build-arg http_proxy="$http_proxy" \
    --build-arg https_proxy="$https_proxy" \
    --build-arg no_proxy="$no_proxy" \
    -q $DIR/.workbench
)

if [[ -z "$@" ]]; then
    CMD=bash
else
    CMD=$@
fi

docker run --rm \
    -e http_proxy="$http_proxy" \
    -e https_proxy="$https_proxy" \
    -e no_proxy="$no_proxy" \
    -v /etc/passwd:/etc/passwd \
    -v /etc/group:/etc/group \
    -v $HOME:$HOME \
    -w $DIR \
    -e USER="$USER" \
    --net host \
    --privileged \
    -it $IMG sudo -u ${USER} -i sh -c "cd $DIR; $CMD"
